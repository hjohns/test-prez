var y=Object.defineProperty;var S=(h,t,e)=>t in h?y(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var p=(h,t,e)=>(S(h,typeof t!="symbol"?t+"":t,e),e);import{E as A}from"./entry.bcf69c92.js";import{D as Q,N as w,a as E,b as H,B as k}from"./axios.7bde71be.js";import{p as D,g as j}from"./str.08505d9c.js";const{namedNode:x}=Q,b=x("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),m=x("http://www.w3.org/2000/01/rdf-schema#label");class N{constructor(){p(this,"store");p(this,"data");p(this,"parser");p(this,"prefixes");p(this,"headerLinks");this.store=new w,this.parser=new E,this.data=[],this.prefixes={},this.headerLinks=[]}async fetch(t,e){try{e={...e,headers:{Accept:"text/anot+turtle"}};const s=await H(t,e);if(s.status!=200)throw new Error(`Request failed with status ${s.status}`);this.headerLinks=D(s.headers.link),await this.load(await s.data)}catch(s){throw s instanceof Error?new Error(`Error: ${s.message}`):new Error("An unknown error occurred.")}}async load(t){await this.parser.parse(t,(e,s,a)=>{a&&(this.prefixes=a),s&&this.data.push(s)}),this.store=new w(this.data)}expandAll(t){return t.map(e=>this.expand(e))}expand(t){const e=t.split(":");return e.length>=2&&e[0]in this.prefixes?(e[0]=this.prefixes[e[0]].toString(),e[0]+e.slice(1).join(":")):t}firstQuad(t,e,s,a){const r=this.store.getQuads(t,e,s,a);return r&&r.length>0?r[0]:null}list(t=[],e=[]){let s="",a=[],r=0;const n=this.firstQuad(null,this.expand("prez:count"),null,null);if(n!==null){r=parseInt(n.object.value),s=n.subject.value;const l=b;a=this.store.getSubjects(l,s,null)}else throw new Error("prez:count predicate not found");const i=this.store.getQuads(s,m,null,null),o=this.compact(s),c={listHeaders:{},header:{label:i.length>0?i[0].object.value:o,iri:s,link:s},count:r,list:[],iri:o},f=this.expandAll(t),u=this.expandAll(e);for(const l in a){const g=a[l].value,v=this.getSubjectData(g,f,u);Object.keys(v).filter(d=>d!="_meta").forEach(d=>{d in c.listHeaders||(c.listHeaders[d]=this.getHeader(this.expand(d),v[d]))}),c.list.push(v)}return c}search(t=[],e=[]){const s=this.list(t,e),a=this.expandAll(t),r=this.expandAll(e);return s.list.forEach(n=>{const i=this.getSubjectData(n.iri,a,r);console.log(i)}),s}form(t=[],e=[],s){console.log("FORM");let a=0,r=s||"";if(r==""){const l=this.firstQuad(null,b,null,null);if(l!==null)r=l.subject.value,l.object.value;else throw new Error("rdf:type predicate not found")}const n=this.store.getQuads(r,m,null,null),i=this.compact(r),o={formHeaders:{},header:{label:n.length>0?n[0].object.value:i,iri:r,link:r},count:a,fields:{},iri:this.compact(r)},c=this.expandAll(t),f=this.expandAll(e),u=this.getSubjectData(r,c,f);return Object.keys(u).filter(l=>l!="_meta").forEach(l=>{l in o.formHeaders||(r[0]!="_"||l!="iri")&&(o.formHeaders[l]=this.getHeader(this.expand(l),u[l]))}),o.count=Object.keys(o.formHeaders).length,o.fields=u,o}getSubjectData(t,e,s){const a={iri:t,_meta:{}},r=this.store.getQuads(t,null,null,null);for(const n in r){const i=r[n],o=this.compact(i.predicate.value),c=this.getMeta(i,e,s);if(console.log(n," = "+i.object.value),console.log("XX"),i.object instanceof k)o in a||(a[o]=[]),a[o].push(this.form(e,s,"_:"+i.object.value));else{const f=this.store.getQuads(t,i.predicate.value,null,null);let u;f.map(l=>{const{label:g,description:v}=this.getAnnotations(l.object.value,e,s),d=g!==void 0?g:l.object.value;u!==void 0?(Array.isArray(u)||(u=[u]),u.push(d)):u=d}),c.value=u===void 0?i.predicate.value:u,a[o]=c.value}a._meta[o]=c}return a}getMeta(t,e,s){const{label:a,description:r}=this.getAnnotations(t.predicate.value,e,s);let n,i;if(t.object.datatype){console.log("DATA TYPE = ",t.object),i=t.object.datatype.value;const c=this.firstQuad(i,m,null,null);n=j(c!==null&&c.object.value?c.object.value.toString():i)}return{iri:t.predicate.value,label:a,description:r,typeIRI:i,type:n}}getHeader(t,e){const s=this.firstQuad(t,m,null,null),a={iri:t,link:m.value,label:j(s!==null&&s.object.value?s.object.value:t),description:""};return console.log("HEAD=",a,"ITEM=",e),a}getAnnotations(t,e,s){let a,r;return e.map(n=>{if(a===void 0){const i=this.firstQuad(t,n,null,null);i&&(a=i.object.value)}}),s.map(n=>{if(r===void 0){const i=this.firstQuad(t,n,null,null);i&&(r=i.object.value)}}),{label:a,description:r}}compact(t){for(const e in this.prefixes)if(t.startsWith(this.prefixes[e].toString()))return`${e}:${t.substring(this.prefixes[e].toString().length)}`;return t==b.value?"rdf:type":t}}const M=A("rdf",{state:()=>({cache:{},loading:!1,error:"",success:!1,prez:null}),actions:{clearCache(){this.cache={}},async load(h,t){try{this.loading=!0,this.success=!1;const e=h+JSON.stringify(t);e in this.cache?this.prez=this.cache[e]:(this.prez=new N,await this.prez.fetch(h,t),this.cache[e]=this.prez),this.success=!0,this.error=null}catch(e){this.error=e.message,this.success=!1}finally{this.loading=!1}}}});export{M as u};
